<% if @game.present? %>
  <div class="GameHeader">
    <%= @game.name %>
  </div>

  <div class="GameSubHeader">
    <div class="WhitePlayerName">
      White Player's Id: <%= @game.white_player_id %>
    </div>
<% end %>

  <div class="BlackPlayerName">
    <% if @game.black_player_id.present? %>
      Black Player's Id: <%= @game.black_player_id %>
    <% else %>
      <p> Waiting for Player... </p>
    <% end %>
  </div>
</div>

<%# <body> %>
  <br/>
  <br/>
  <div class="castling">
    <% if (!queenside_rook.nil? && legal_to_castle?(king_to_castle.x_coordinate - 2, king_to_castle.y_coordinate)) || (!kingside_rook.nil? && legal_to_castle?(king_to_castle.x_coordinate + 2, king_to_castle.y_coordinate)) %>

      <% if !queenside_rook.nil? && legal_to_castle?(king_to_castle.x_coordinate - 2, king_to_castle.y_coordinate) %>
        <%= link_to 'Your Queenside Rook', castling_piece_path(queenside_rook), class: 'btn btn-info btn-sm', method: :put %>
      <% end %>
      <br />
      <% if !kingside_rook.nil? && legal_to_castle?(king_to_castle.x_coordinate + 2, king_to_castle.y_coordinate) %>
        <%= link_to 'Your Kingside Rook', castling_piece_path(kingside_rook), class: 'btn btn-info btn-sm', method: :put %>
      <% end %>
    <% end %>
  </div> 

  <div class="chessboard col-6">
    <table>
      <tbody>
          <% (1..8).each do |y_coord| %>
            <tr id = <%= y_coord %>>
              <% (1..8).each do |x_coord| %>
                <td data-x-coord= <%= x_coord %> data-y-coord= <%= y_coord %> 
                    class = droppable 
                    <%= "#{(y_coord % 2 == x_coord % 2 ? "white-square droppable-square" : "black-square droppable-square")}" %> >
                      <% if boardpiece = @pieces.where("(x_coordinate = ? AND y_coordinate = ?)", x_coord, y_coord).first %>
                        <span class= "piece" data-id=<%= boardpiece.id %> id="<%= boardpiece.id %>" data-x-coord= <%= x_coord %> data-y-coord= <%= y_coord %> >
                          <%= image_tag boardpiece.image %>
                        </span> 
                      <% end %>
                </td>
              <% end %>
            </tr>
          <% end %>
      </tbody>
    </table>
  </div>
<%# </body> %>

<!------- For Firebase Add----->
 <script src="https://www.gstatic.com/firebasejs/7.2.1/firebase-app.js"></script>
 <script src="https://www.gstatic.com/firebasejs/7.2.1/firebase-firestore.js"></script>

<script>
// Your web app's Firebase configuration - remember to hid API KEY/APP ID, Messaging Send ID and Measurement ID in application YML - try <%= ["FIREBASE_API_KEY"]>
  var firebaseConfig = {
    apiKey: "",
    authDomain: "bad-bishop.firebaseapp.com",
    databaseURL: "https://bad-bishop.firebaseio.com",
    projectId: "bad-bishop",
    storageBucket: "bad-bishop.appspot.com",
    messagingSenderId: "",
    appId: "",
    measurementId: ""
  };
  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);


</script>


<script>
$(document).ready($(function() {
    $('.piece').draggable({ 
        snap: 'droppable',
        revert: 'invalid'
      });
    $('.droppable').droppable({
        drop: function(event, ui) {
          let piece = ui.draggable
          let destination_square = $(this);
          var update_piece = {
            id: piece.data('id'),
            game_id: piece.data('game-id'),
            x_coordinate: destination_square.data('x-coord'),
            y_coordinate: destination_square.data('y-coord')
          }
          $.ajax({
            type: 'PUT',
            url: `/pieces/${update_piece.id}`,
            dataType: 'json',
            data: {
              piece: {
                game_id: update_piece.game_id, 
                id: update_piece.id,
                x_coordinate: update_piece.x_coordinate,
                y_coordinate: update_piece.y_coordinate
              },
            },
            success: function(data) {
              destination_square.empty();
              location.reload(true);
            }
          });
        }  
      });    
      
    }));
</script>
