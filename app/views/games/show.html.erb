<% if @game.present? %>
<div class="GameHeader">
    <%= @game.name %>
</div>
<div class="GameSubHeader">
    <div class="WhitePlayerName">
        <%= @game.white_player_id %>
    </div>
    <% end %>
    <div class="BlackPlayerName">
        <% if @game.black_player_id.present? %>
        <%= @game.black_player_id %>
        <% else %>
        <p> Waiting for Player... </p>
        <% end %>
    </div>
</div>

<body>
    <br />
    <br />
    <br />
    <br />
    <br />
    <div class="chessboard col-6">
        <table>
            <tbody>
                <% (1..8).each do |y_coord| %>
                <tr id=<%=y_coord %>>
                    <% (1..8).each do |x_coord| %>
                    <td data-x-coord=<%=x_coord %> data-y-coord =
                        <%= y_coord %> class = "droppable"
                        <%= "#{(y_coord % 2 == x_coord % 2 ? "white-square droppable-square" : "black-square droppable-square")}" %> >
                        <% board_piece = @pieces.where("(x_coordinate = ? AND y_coordinate = ?)", x_coord, y_coord).first %>
                        <% if board_piece.present? %>
                        <div class="piece" data-piece-id="<%=board_piece.id%>" data-x-coord=<%=x_coord %> data-y-coord =
                            <%= y_coord %>>
                            <%= board_piece.unicode_symbol.html_safe %>
                        </div>
                        <% end %>
                    </td>
                    <% end %>
                </tr>
                <% end %>
            </tbody>
        </table>
    </div>
</body>
<script>
$(document).ready(function() {
    $('.piece').draggable({
        snap: '.droppable',
        revert: 'invalid'
    });
    $('.droppable').droppable({
        drop: function(event, ui) {
            var piece = ui.draggable
            var destination_square = $(this);
            var update_piece = {
                id: piece.data('piece-id'),
                x_coordinate: destination_square.data('x-coord'),
                y_coordinate: destination_square.data('y-coord'),

            }

            $.ajax({
                type: 'PATCH',
                url: '/pieces/' + update_piece.id,
                beforeSend: function(xhr) { xhr.setRequestHeader('X-CSRF-Token', $('meta[name="csrf-token"]').attr('content')) },
                dataType: 'json',
                data: { piece_id: update_piece.id, x_coordinate: update_piece.x_coord, y_coordinate: update_piece.y_coord },
                success: function(data) {
                    destination_square.empty();
                    location.reload(true);
                }

            });

        }
    });
});
</script>