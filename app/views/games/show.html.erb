<% if @game.present? %>
<div class="GameHeader">
    <%= @game.name %>
</div>
<div class="GameSubHeader">
    <div class="WhitePlayerName">
        <%= @game.white_player_id %>
    </div>
    <% end %>
    <div class="BlackPlayerName">
        <% if @game.black_player_id.present? %>
        <%= @game.black_player_id %>
        <% else %>
        <p> Waiting for Player... </p>
        <% end %>
    </div>
</div>

<body>
    <br />
    <br />
    <br />
    <br />
    <br />
    <div class="chessboard col-6">
        <table>
            <tbody>
                <% (1..8).each do |y| %>
                <tr id=<%=y %>>
                    <% (1..8).each do |x| %>
                    <td data-x-coord=<%=x %> data-y-coord =
                        <%= y %> class = "droppable"
                        <%= "#{(y % 2 == x % 2 ? "white-square droppable-square" : "black-square droppable-square")}" %> >
                        <% board_piece = @pieces.where("(x_coordinate = ? AND y_coordinate = ?)", x, y).first %>
                        <% if board_piece.present? %>
                        <div class="piece" data-id="<%=board_piece.id%>" data-x_coord=<%=x %> data-y_coord =
                            <%= y %>>
                            <div class="piece-size text-center">
                                <%= board_piece.unicode_symbol.html_safe %>
                            </div>
                        </div>
                        <% end %>
                    </td>
                    <% end %>
                </tr>
                <% end %>
            </tbody>
        </table>
    </div>
</body>
<script>
$(document).ready(function() {
    $('.piece').draggable({
        snap: '.droppable',
        revert: 'invalid'
    });

    $('.droppable').droppable({
        drop: function(event, ui) {
            var piece = ui.draggable
            var destination_square = $(this);
            var update_piece = {
                id: piece.data('id'),
                x_coordinate: destination_square.data('x-coord'),
                y_coordinate: destination_square.data('y-coord'),
            }

            $.ajax({
                type: 'PATCH',
                url: '/pieces/' + update_piece.id,
                beforeSend: function(xhr) { xhr.setRequestHeader('X-CSRF-Token', $('meta[name="csrf-token"]').attr('content')) },
                dataType: 'json',
                data: { id: update_piece.id, x_coordinate: update_piece.x_coordinate, y_coordinate: update_piece.y_coordinate },
                success: function(data) {
                    destination_square.empty();
                    location.reload(true);
                }
            });
        }
    });
});
</script>